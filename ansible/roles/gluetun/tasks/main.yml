---
- name: Start Gluetun VPN
  when: gluetun_enabled is true
  block:
    - name: Create Gluetun Directory
      ansible.builtin.file:
        path: "{{ gluetun_config_directory }}"
        state: directory
        mode: "0755"

    - name: Create Gluetun Docker Container
      community.docker.docker_container:
        name: "{{ gluetun_container_name }}"
        image: "{{gluetun_image_name}}:{{ gluetun_image_version }}"
        capabilities:
          - NET_ADMIN
        devices:
          - /dev/net/tun:/dev/net/tun
        ports:
          - 6881:6881/tcp # qbittorrent
          - 6881:6881/udp # qbittorrent
        volumes:
          - "{{ gluetun_config_directory }}:/gluetun"
        env:
          VPN_SERVICE_PROVIDER: "nordvpn"
          VPN_TYPE: "openvpn"
          OPENVPN_USER: "{{ nordvpn_username }}"
          OPENVPN_PASSWORD: "{{ nordvpn_password }}"
          SERVER_COUNTRIES: "{{ nordvpn_countries }}"
          TZ: "{{ core_timezone }}"
        networks:
          - name: "proxy"
        pull: true
        restart_policy: unless-stopped
        labels:
          traefik.enable: "true"
          traefik.http.routers.qbittorrent.rule: "Host(`{{ qbittorrent_domain }}.{{ lyoko_domain }}`)"
          traefik.http.routers.qbittorrent.entrypoints: "websecure"
          traefik.http.routers.qbittorrent.tls.certresolver: "cloudflare"
          traefik.http.routers.qbittorrent.service: "qbittorrent"
          traefik.http.services.qbittorrent.loadbalancer.server.port: "8080"
          traefik.docker.network: "proxy"