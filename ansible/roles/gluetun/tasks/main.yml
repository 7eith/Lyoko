---
- name: Start Gluetun VPN
  when: gluetun_enabled is true
  block:
    - name: Create Gluetun Directory
      ansible.builtin.file:
        path: "{{ gluetun_config_directory }}"
        state: directory
        mode: "0755"

    - name: Create Gluetun Docker Container
      community.docker.docker_container:
        name: "{{ gluetun_container_name }}"
        image: "{{gluetun_image_name}}:{{ gluetun_image_version }}"
        capabilities:
          - NET_ADMIN
        devices:
          - /dev/net/tun:/dev/net/tun
        ports:
          - 6881:6881/tcp # qbittorrent
          - 6881:6881/udp # qbittorrent
        volumes:
          - "{{ gluetun_config_directory }}:/gluetun"
        env:
          TZ: "{{ core_timezone }}"
          VPN_SERVICE_PROVIDER: "airvpn"
          VPN_TYPE: "wireguard"
          WIREGUARD_PRIVATE_KEY: "{{ wireguard_private_key }}"
          WIREGUARD_PRESHARED_KEY: "{{ wireguard_preshared_key }}"
          WIREGUARD_ADDRESSES: "{{ wireguard_addresses }}"
          WIREGUARD_MTU: "1320"
          DOT: "off"
          DNS_UPDATE_PERIOD: "0"
          FIREWALL_VPN_INPUT_PORTS: "{{ wireguard_forwarded_port }}"
          SERVER_COUNTRIES: "{{ wireguard_countries }}"
        networks:
          - name: "proxy"
        pull: true
        restart_policy: unless-stopped
        labels:
          traefik.enable: "true"
          traefik.http.routers.qbittorrent.rule: "Host(`{{ qbittorrent_domain }}.{{ lyoko_domain }}`)"
          traefik.http.routers.qbittorrent.entrypoints: "websecure"
          traefik.http.routers.qbittorrent.tls.certresolver: "cloudflare"
          traefik.http.routers.qbittorrent.service: "qbittorrent"
          traefik.http.services.qbittorrent.loadbalancer.server.port: "8080"
          traefik.docker.network: "proxy"